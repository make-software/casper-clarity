const got = require('got');
const readline = require('readline');
const Storage = require('./storage');
const models = require('../src/models/index');
const env = process.env.NODE_ENV || 'development';
const config = require(__dirname + '/../config/eh-config.json')[env];

// Tagging test
function formNodeURL(lastEventId) {
    const protocol = config.EH_STREAM_PROTOCOL;
    const domain = process.env.NODE_ADDRESS ? process.env.NODE_ADDRESS : config.EH_STREAM_DOMAIN;
    const port = config.EH_STREAM_PORT;
    const path = process.env.NODE_PATH ? process.env.NODE_PATH : config.EH_STREAM_PATH;
    const bufferSize = process.env.BUFFER_SIZE ? process.env.BUFFER_SIZE : 25000;

    if (false === lastEventId) {
        console.log('Info: Not catching up. Reading event stream from now.');
        return protocol + '://' + domain +
            (port ? ':' + port : '') +
            (path ? '/' + path : '');
    }

    const startFromEventId = lastEventId
        ? Math.max(0, lastEventId - bufferSize)
        : 0;

    console.log('Info: Catching up from event id ' + startFromEventId);

    return protocol + '://' + domain +
        (port ? ':' + port : '') +
        (path ? '/' + path : '') +
        '?start_from=' + startFromEventId;
}

async function runEventHandler() {
    try {
        console.log('Info: Syncing database schema');
        await models.sequelize.sync({ force: false, logging: false });

        const storage = new Storage(models);

        const sourceNodeAddress = process.env.NODE_ADDRESS ? process.env.NODE_ADDRESS : config.EH_STREAM_DOMAIN;
        const sourceNode = await storage.findSourceNodeByAddressOrCreate(sourceNodeAddress);

        const prefetchStream = readline.createInterface({
            input: got.stream(formNodeURL(false)),
            crlfDelay: Infinity
        });

        console.log('Info: Pre-fetching protocol version');
        let firstEvent,
            apiVersionVersion;

        // Dear reader, I have no idea why I can't do prefetchStream.next() as on normal iterator
        for await (let eventString of prefetchStream) {
            if (!eventString.startsWith('data')) {
                throw new Error('Error: First event is not data event');
            }

            firstEvent = JSON.parse(eventString.substr(5));
            if (!firstEvent.ApiVersion) {
                throw new Error('Error: First event is not ApiVersion');
            }

            apiVersionVersion = firstEvent.ApiVersion;
            console.log('Info: Protocol version is ' + apiVersionVersion);
            break;
        }

        const apiVersion = await storage.findApiVersionByVersionOrCreate(apiVersionVersion);
        const lastEventId = await storage.getLastEventId(sourceNode.id, apiVersion.id);

        // @todo Retry on failed connection
        console.log('Info: Connecting to the event stream');
        const stream = readline.createInterface({
            input: got.stream(formNodeURL(lastEventId)),
            crlfDelay: Infinity
        });

        // storage.onEvent(sourceNode.id, apiVersion.id, '{"BlockAdded":{"block_hash":"5283fe7cc4cc317803269023c699124575f1b93acc0aa051efd14da8824a0863","block":{"hash":"5283fe7cc4cc317803269023c699124575f1b93acc0aa051efd14da8824a0863","header":{"parent_hash":"218bb081a504cbb9085713d6addae5d944c586c34c49c46bfbcec12238e884d9","state_root_hash":"d546e91bc7d66feff4cbbab894f8aec6a9addc54c5888e176fdf3c8e1a385996","body_hash":"ac2228a2d0b6ef1f2f0151b929d11cacf9d72ce7bc2b614b15408c11e7afede9","random_bit":false,"accumulated_seed":"b96585e65f054ec2baf53fa834963670f0b7c6e48b801a9ea82b4cf930894bd8","era_end":{"era_report":{"equivocators":[],"rewards":{"0102b0d1560c9909760a778b4b2ef5601461221c117e57c33ca8571888515ca65d":28085463,"010427c1d1227c9d2aafe8c06c6e6b276da8dcd8fd170ca848b8e3e8e1038a6dc8":53361357,"0105220d6629f6ef4484e2da5f58b6222832af8cabba4fbd7f1ad55e84a06ab319":2023957759,"01068e4432b4ac5f6469fe08a92f84ebb7518b1a1a7f6b42651803067035fdca82":1122635627,"01074597a876bc3af182c41990cc5752a1ceba49ef82c455ff9051f932d96af6b4":41909636,"01075ec8809c691a1d1b0250ba9ea75da5460e3df43c3172771c6975c989457159":1164644200161,"010a0edc88c2f20b0934923f7078a9c4611e37d6317309b4fc302d8222f0a1075d":1948596727360,"010d69a3bc86aed2a94e043e5a3ec9c5c710aecbb6b07d8fb5ba16cd4cfbbaa2fa":40710125,"010fe1c87fe78e4bd89c767f1c8b9ba0a90ff5537e47e3ed006efccb8e67762830":28084623,"0110f08913481ec34b6a8f0437734d581b4dcb50f2ceb5085cbd09b7fdd66e85b8":28053018,"0112357f15cf6461a772978c6fc72d93bc10c1abda3a85ee7b7feb593c785b95be":28255496,"0119e05ded8a483e3c99a6c6a90cfe3a99ee33afa6083225b99a5a468ddddbdb0e":28017926,"011bb356b5af429f397bc5b0fbc71bb2b2384d6253b7f3cda92db8758dbdc4c728":84113525,"0122f8d85b44cc2daee730c2afa97cdd6d0b46a9e132dd18292e39f8193b24d037":84285557,"0124bc9f7cc9f53a34c79d7ab94f2926c7ad368ca8bcd11b2142f01a005526d2c5":0,"0125c16a4a387062414d59eb2a1387d3b380a1d4fede2994c582d07510a004c027":4034264139781,"01260f18d5f4939822731f010aff192dffef3243abaab455c02872ba866b663b71":731132906194,"01267447c9ac87b4330ed3395db95efbba78394533666f29a56e8a1ec7b31abbd4":28061648,"012a7750db3ad70a6adaecd353ddfc9c13f3694659d2e55d9460b6ca10648c02f3":28085463,"012dc55b77b2a9faf75dbaed15775ddfc48e60c4596608318c8b96b1900bdf1d5f":55694730,"012e26890209f5234fdc707c2086ef84314bba0e2cc9c7cdbe199859152b3fdc30":609277398397,"012ee2b234fc8b90911c3327b41d4dc450ad4549e1549fa40c467e298d67e50a8f":28030149,"012fb545d46b2d2d4c2d00ce2d04a88d958149dfaef2298d9dc4f2f93c075bae34":27980841,"0131ecf1f10fdfe28b4ff11f67049a4583902ed315252b57cb4483a61c39593035":21837886,"0135251e59c6f01800c51c4961ef37ebd34575e28c0942fdffd2ea34b09c54f86a":3655666173112,"0138e7246e373b4b925e1081741794c77a5866cdf90061965442134f0fe59c60a1":31573499,"013d357017db22c9135245601751e5da3be0de9fee01fd2ba919e07c6ee98c5837":28084601,"013f774a58f4d40bd9b6cce7e306e53646913860ef2a111d00f0fe7794010c4012":9373528895436,"0140e8b6d23614355e04e1e1fab97d54ea3cb6fa1e6db6c65ba6cb21ee7c6a81cc":1827831938777,"0142f890ea38eacce7d24473d837147a0312c0db7400e5671fadc5b985090e1ecc":935453774130,"0146c61d107ffb32738fdbb837213b240bf872536f326465642e467fe6884e7cdc":28972545,"01473e65039f446dab9c1953e0ef951c1d46a60d4de44b95643bc3c80c70134af3":28084496,"014b466f5c6c87bb1d2566d166120e320a724231374cd0775e0e347afed70a4745":55098728,"014c28b6968597cbadb50ed0468f9a4f0dbfcac6e06737345e04e4d2f99f0002dd":1032489555322,"014d191c1f2fb220bad636cbdddf50f3002d3127731082caf5fa2fab0df9f37419":28052157,"014d5eb3ac23735e695ae372defa057ca089a921f08a199415cc73fd118f68dc94":609276980688,"014fdd08ed688b19cd92fb93be9b2a9108361f63edc7d0b1fda84f3e45e3bbd8e3":1068360802175,"0155737201251fe651ef332c6b21627498145490e8534f8b7a1d5f3a5d98ceaa67":28089659,"01587265e95c4d895c912d3091b76d7d6034f9b5b6c38074c8f88244f65813cb0c":2941100155593,"015c3b543739fe8fa56cb1b09a91c3ed8ec0febbe6977bd8cb5273956094b8d7bb":487421960128,"015da9ac1f6508be409bc6ed45bc44c6afd6d94b90d60014576418a79b61d563a2":3050308242686,"0161a3701643407ee0094844264e43c2f8443e07c6871c16e94116a56b3028d3a5":1989673184996,"0161c5fdc6db7ddaa7770478fcba908412bdd570fb8b5133c81b7db707400c9d47":84000692,"0167601f851607ac0279fd8e7a2af6abe280b7c9dc52dc21d27bc0eab431d14fd4":30930627,"01683b6e508120d7e970f86cdc29e7a317b5d18925cc368f4400c4e39e06ea879d":609277137764,"016c32abc5867fb9d5fac0ff6b6cdb959101a505a2e8137ea8ca07e120a4775aa8":84088664,"016df1d80aafc6cca6dc54248132386a1188b665f6ce92b6f4e218fc408aa3dc4b":868843745,"016ffbc278c0268817468117f2b59141b666422b9b251b5c2c0bb8a17c26fe575b":28085148,"0173d441e42fc9ededfa47073ea0023b1c9488087efa5f631e35103d8a1efc1e7f":51844568,"0180187dda20ca4d0108ea54a31a6764bbd46c01420b1ab53e714f8761372a7ad3":148678067,"01840a8258ad22e9f1237f4d96a36fc2841635ba8d831fb73956f55426fbce54b1":878596206918,"01852d3355d56dcb1c62fae151aef4ab264739af6e32e247dc9b5237b096472983":27606962,"0188a8f71663f01d2cf394d7e0ce577bd11b34bb6d2aa55f09071fb3c64f94a51b":28086092,"0188d873a9e784e824ef3bd1581a4994fbb5eead58cb92e909542c7b9d65b15ae7":35959476,"0189427f604fbfa62aa7d204a6c3f0034a910be6a4a5839cbf53cc10361b5e4c28":674661052,"018977df4885899e3791ca6011ad46f3285d48a8b47900f92c5a7dd04af4c05d35":28061582,"018b15761be0c527117c79b87ca013b014a4628f01e382902a139529406723d86b":9373500804806,"018db4ea42689acfc05449c87eeb7970bc6f4bacd6571f8361ffc17dd9d6ae7914":1023701716041,"018dc552de3c403dbefe03a9c604e11346d96159ed49f9381a55c2e06c45197d43":405173386420,"019078cbad006cf86c6f3e8b226f8ad3d24d346952077152d6d9a5d13f02658554":28118748,"0190dd8430afb0958c25636596d1e98478ebe240c81260becf687cdf90ee088860":609277547264,"01921a3c9c9837c9e11cf34d2495abb522a7d5f74bc2218df45fefb91c96deb988":4034253765087,"0192fe0efbf65cafa7aca49094af2fe01b4ed8bc8abdbd8c078476e9650c4b99ae":776202482247,"0199bc243a7497f5b0f384636cf5fe6c6f7f33113061de613959564c574ec8d61b":28085253,"019a85d7370f913f0a9f55a12da2b031d8c0a36752cd8fd7ff0b47cff0d4fc57bd":28055852,"019d4fa301d6a288609dcd2fa85dc84dbed8ee9361cbbf40e4c85071da2a4332d2":852988550959,"01a4707d761e69f5838d77c2edcf378e9c51a82048fdafff389bba60aeff58210e":4684625149338,"01b1e495b07045f098d04d729947d8efb6a471c7b5ba69b461c980a276f56957c1":3046386608209,"01b242ed64fdafb8bdfc2f52ef8571ce12c348a664442cba4a1c079ea5d9a26c0a":4686750078227,"01b40a3ade2c223139c2928f2481e9782768ed2b3500bbc2efc191ef29c856284a":556217226,"01b4447a791cfea22f8293a165e7c7895121347a18845791c6bdea536437be99b4":84144080,"01b677d508c9b784c376c799033b20c1d1398694e2fe734f2e262a18600dc630fa":1070959928172,"01b7a5935f85710aa79e346bfe93f90d813bc20234dbd9211bcf8d2af8784520c2":487400277546,"01b9137fcbb85baf03db2aa41e459199b27514a9943a0d2776752974c793905880":1013785820360,"01b9c53d13b3c6021f3dcc1f7dca5c22b01b5ac6a273b8054e9a8dd090e739a848":4208968941793,"01bb61d3077d403e9429200265fbbe1f3f0521b6d07efc2daff7f29e37393c5731":2149347960484,"01bb9d7599bb8a0464946f8b7d812db16c80fb66ae345a7649d8cba96215b4a591":1218559181636,"01c3e639b8a789b61ec3ec10d32aa928496fd2a8239b90116db0c10008a8bb468f":918937785022,"01c444f05da5781071c6375575d713193f4495bd6d83c4ef4e788502e2c8c09a9d":84086225,"01c485e408cb73557a008f28a5761a7368e0a0dccfe89ea6ffcd3883d41d3065be":757712405609,"01c91d7ac17e2289740a33d61c4dffeab43937f6c1fc0820ebcea2c199ccd73e16":28089767,"01cee72144d6729a450cc929b738311f0cf6a32e5ba872466d8dd57c6b8b0b9121":28068806,"01d2000024c05927e9958293bcb4de2e8f5e85b99f23e4260008e56dcd2088fd8e":1185039027166,"01d62fc9b894218bfbe8eebcc4a28a1fc4cb3a5c6120bb0027207ba8214439929e":9373500804806,"01d77dbc0e3a798edfba46ff234c3109184c28de48c600a09c17850098d1747c1c":4034241716342,"01dbf36160e6cf1664bcf3a510e19f606c1d84dc5e53dd08d7e4a9ade9db126dff":609277107947,"01ddcb70a7d309e0c96ded5587c40734cfda361194d93b8187c128cddac7b18ed4":27952407,"01de0f987b1085ff99283fde29f7b18b0b52c97d94f5b2124630017ada60de0982":28062526,"01e04018a67f239124ab5769db728b9bb586139af782e2b30bb06144b7914fbdd3":84141641,"01e2b343688101930b63af177df340815c1d8ce16dd9bc2f799902cb52d64bd5a5":28085462,"01f210a4e89a5a4e81f4ccd6cf7a9e7c9d6dc25b168afafa7da7a5ec4809ad2649":773198015175,"01f24c144f286126b1f85984843e393e1b95d05f6b6d7eed6a6148b6adc8668c3d":782903251206,"01f2a124115721f18b7c1ace2b2d8b6d4980e7a7263b53936a41288fbfe2f220cb":28084623,"01f35b161e8e73fe079e37c15b7edd58b6293c0ac41bd4cdf1ae27b970227dada2":1088426067706,"01f39dacb5ca4ac415041d1df96f043abe911e385cf6da99532287ebfc7947cbe0":53386116,"01f8cc19ba142d7e82de13065634de13f011f3ca32141ec144cc6e4fdfd2697ce3":785447517517,"01f93b4d887963276b11859aef9959b4caff61bd0cee5859698f4f9be367320681":771580154324,"01f979b2820db754b82c25823f9886d3fc1e941e3442372dc9d40d0d2fd29156ce":28081137,"01f9a00a3712a1ba5dcee00af368f07d384ccaebb3c840c34c5b322395419ba4d9":4686750402402,"01fe61249c459693809bf4f789dd38bc3b7772aa4ffaf642cc6993f4a1004df6c1":1121069701456},"inactive_validators":["0124bc9f7cc9f53a34c79d7ab94f2926c7ad368ca8bcd11b2142f01a005526d2c5"]},"next_era_validator_weights":{"0102b0d1560c9909760a778b4b2ef5601461221c117e57c33ca8571888515ca65d":"1000088060494","010427c1d1227c9d2aafe8c06c6e6b276da8dcd8fd170ca848b8e3e8e1038a6dc8":"1900131445971","0105220d6629f6ef4484e2da5f58b6222832af8cabba4fbd7f1ad55e84a06ab319":"72070506738839","0105e2c338d31db049db93012f9a158993c0f5e330bf6c71ac38c165b1047af511":"1020000000000","01068e4432b4ac5f6469fe08a92f84ebb7518b1a1a7f6b42651803067035fdca82":"39975596190764","01074597a876bc3af182c41990cc5752a1ceba49ef82c455ff9051f932d96af6b4":"1492348512532","01075ec8809c691a1d1b0250ba9ea75da5460e3df43c3172771c6975c989457159":"41471465744378957","010819b194079ef88b6ce54b85c3ca75318dead7984d9ff36f9fcdf84eb089d638":"18971000000000","010a0edc88c2f20b0934923f7078a9c4611e37d6317309b4fc302d8222f0a1075d":"69386995973053187","010d69a3bc86aed2a94e043e5a3ec9c5c710aecbb6b07d8fb5ba16cd4cfbbaa2fa":"1450267003372","010fe1c87fe78e4bd89c767f1c8b9ba0a90ff5537e47e3ed006efccb8e67762830":"1000057860222","0112357f15cf6461a772978c6fc72d93bc10c1abda3a85ee7b7feb593c785b95be":"1006141687956","011538e2431680e2873a60c00b23839af9e45088adb240a12621479c951afc566c":"1020000000000","011a65da6d839ecf30e4ef24952ee84125f7a955291cd752324ea44a98b65c7614":"1020000000000","011bb356b5af429f397bc5b0fbc71bb2b2384d6253b7f3cda92db8758dbdc4c728":"2995174189060","0122f8d85b44cc2daee730c2afa97cdd6d0b46a9e132dd18292e39f8193b24d037":"3001301660564","0124bc9f7cc9f53a34c79d7ab94f2926c7ad368ca8bcd11b2142f01a005526d2c5":"1070000000000","0125c16a4a387062414d59eb2a1387d3b380a1d4fede2994c582d07510a004c027":"143654900827387754","01260f18d5f4939822731f010aff192dffef3243abaab455c02872ba866b663b71":"26034692200594548","01267447c9ac87b4330ed3395db95efbba78394533666f29a56e8a1ec7b31abbd4":"999239370029","012836dbe9919b1ee2b93636853ac4190e891f5f815fcc8181166e308d4050ddb3":"1020000000000","012a7750db3ad70a6adaecd353ddfc9c13f3694659d2e55d9460b6ca10648c02f3":"1000088293836","012dc55b77b2a9faf75dbaed15775ddfc48e60c4596608318c8b96b1900bdf1d5f":"1983218768969","012e26890209f5234fdc707c2086ef84314bba0e2cc9c7cdbe199859152b3fdc30":"21695576000228726","0135251e59c6f01800c51c4961ef37ebd34575e28c0942fdffd2ea34b09c54f86a":"130173519472778431","0138e7246e373b4b925e1081741794c77a5866cdf90061965442134f0fe59c60a1":"1124292219870","013d357017db22c9135245601751e5da3be0de9fee01fd2ba919e07c6ee98c5837":"1000057217093","013f774a58f4d40bd9b6cce7e306e53646913860ef2a111d00f0fe7794010c4012":"333779176876977986","0140e8b6d23614355e04e1e1fab97d54ea3cb6fa1e6db6c65ba6cb21ee7c6a81cc":"65086718865265923","0142f890ea38eacce7d24473d837147a0312c0db7400e5671fadc5b985090e1ecc":"33310292657355020","0146c61d107ffb32738fdbb837213b240bf872536f326465642e467fe6884e7cdc":"1031677848553","01473e65039f446dab9c1953e0ef951c1d46a60d4de44b95643bc3c80c70134af3":"1000053728207","014b466f5c6c87bb1d2566d166120e320a724231374cd0775e0e347afed70a4745":"1961995266917","014c28b6968597cbadb50ed0468f9a4f0dbfcac6e06737345e04e4d2f99f0002dd":"36765610665180498","014d5eb3ac23735e695ae372defa057ca089a921f08a199415cc73fd118f68dc94":"21695561127127754","014fdd08ed688b19cd92fb93be9b2a9108361f63edc7d0b1fda84f3e45e3bbd8e3":"38042939125995848","0155737201251fe651ef332c6b21627498145490e8534f8b7a1d5f3a5d98ceaa67":"1000236895350","01587265e95c4d895c912d3091b76d7d6034f9b5b6c38074c8f88244f65813cb0c":"104728752638556964","015c3b543739fe8fa56cb1b09a91c3ed8ec0febbe6977bd8cb5273956094b8d7bb":"17356462274201586","015da9ac1f6508be409bc6ed45bc44c6afd6d94b90d60014576418a79b61d563a2":"108617510633142513","015e8eb1a4bcbe3b6d786ca160ba5ee8d49671a3f3bb496728879370eae1c1d4c1":"1020000000000","0161a3701643407ee0094844264e43c2f8443e07c6871c16e94116a56b3028d3a5":"70849675224298685","0161c5fdc6db7ddaa7770478fcba908412bdd570fb8b5133c81b7db707400c9d47":"2991157318833","0167601f851607ac0279fd8e7a2af6abe280b7c9dc52dc21d27bc0eab431d14fd4":"1101401094241","0167706181a308089391dda197cad09b836f2a2870bbf62ad7080780a8ea952669":"1020000000000","01683b6e508120d7e970f86cdc29e7a317b5d18925cc368f4400c4e39e06ea879d":"21695566718847966","0169740c39d54535e8702b03e80f3dc799b63c258319abe4b42547195ad0cf1b7a":"1020000000000","016c32abc5867fb9d5fac0ff6b6cdb959101a505a2e8137ea8ca07e120a4775aa8":"2994291039969","016df1d80aafc6cca6dc54248132386a1188b665f6ce92b6f4e218fc408aa3dc4b":"30938398699437","016ffbc278c0268817468117f2b59141b666422b9b251b5c2c0bb8a17c26fe575b":"1000078940265","0173d441e42fc9ededfa47073ea0023b1c9488087efa5f631e35103d8a1efc1e7f":"1846119293753","0180187dda20ca4d0108ea54a31a6764bbd46c01420b1ab53e714f8761372a7ad3":"5294234302128","01840a8258ad22e9f1237f4d96a36fc2841635ba8d831fb73956f55426fbce54b1":"31285668612927143","01852d3355d56dcb1c62fae151aef4ab264739af6e32e247dc9b5237b096472983":"999917979995","0188a8f71663f01d2cf394d7e0ce577bd11b34bb6d2aa55f09071fb3c64f94a51b":"1000109891962","0188d873a9e784e824ef3bd1581a4994fbb5eead58cb92e909542c7b9d65b15ae7":"1280471607322","0189427f604fbfa62aa7d204a6c3f0034a910be6a4a5839cbf53cc10361b5e4c28":"24023806335851","018977df4885899e3791ca6011ad46f3285d48a8b47900f92c5a7dd04af4c05d35":"999672913246","018b15761be0c527117c79b87ca013b014a4628f01e382902a139529406723d86b":"333778176604527064","018db4ea42689acfc05449c87eeb7970bc6f4bacd6571f8361ffc17dd9d6ae7914":"36452687133317872","018dc552de3c403dbefe03a9c604e11346d96159ed49f9381a55c2e06c45197d43":"17368603840355340","019078cbad006cf86c6f3e8b226f8ad3d24d346952077152d6d9a5d13f02658554":"1001273480793","0190dd8430afb0958c25636596d1e98478ebe240c81260becf687cdf90ee088860":"21695581300813869","01921a3c9c9837c9e11cf34d2495abb522a7d5f74bc2218df45fefb91c96deb988":"143654531397459902","0192fe0efbf65cafa7aca49094af2fe01b4ed8bc8abdbd8c078476e9650c4b99ae":"27639561208012136","0199bc243a7497f5b0f384636cf5fe6c6f7f33113061de613959564c574ec8d61b":"1000082686362","019d4fa301d6a288609dcd2fa85dc84dbed8ee9361cbbf40e4c85071da2a4332d2":"30373813280644534","01a4707d761e69f5838d77c2edcf378e9c51a82048fdafff389bba60aeff58210e":"166813411003182063","01b1e495b07045f098d04d729947d8efb6a471c7b5ba69b461c980a276f56957c1":"108477866327651020","01b242ed64fdafb8bdfc2f52ef8571ce12c348a664442cba4a1c079ea5d9a26c0a":"166889076759934967","01b40a3ade2c223139c2928f2481e9782768ed2b3500bbc2efc191ef29c856284a":"19806173242380","01b4447a791cfea22f8293a165e7c7895121347a18845791c6bdea536437be99b4":"2996263467329","01b677d508c9b784c376c799033b20c1d1398694e2fe734f2e262a18600dc630fa":"38135490624655439","01b7a5935f85710aa79e346bfe93f90d813bc20234dbd9211bcf8d2af8784520c2":"17355690187553733","01b9137fcbb85baf03db2aa41e459199b27514a9943a0d2776752974c793905880":"36099594979151935","01b9c53d13b3c6021f3dcc1f7dca5c22b01b5ac6a273b8054e9a8dd090e739a848":"149875911683746031","01bb61d3077d403e9429200265fbbe1f3f0521b6d07efc2daff7f29e37393c5731":"76535486376778910","01bb9d7599bb8a0464946f8b7d812db16c80fb66ae345a7649d8cba96215b4a591":"43391308137177682","01c3e639b8a789b61ec3ec10d32aa928496fd2a8239b90116db0c10008a8bb468f":"32722179759154169","01c444f05da5781071c6375575d713193f4495bd6d83c4ef4e788502e2c8c09a9d":"2994203159143","01c485e408cb73557a008f28a5761a7368e0a0dccfe89ea6ffcd3883d41d3065be":"26981153617694965","01c91d7ac17e2289740a33d61c4dffeab43937f6c1fc0820ebcea2c199ccd73e16":"1000241355952","01cee72144d6729a450cc929b738311f0cf6a32e5ba872466d8dd57c6b8b0b9121":"999494080981","01d2000024c05927e9958293bcb4de2e8f5e85b99f23e4260008e56dcd2088fd8e":"43711416608583302","01d62fc9b894218bfbe8eebcc4a28a1fc4cb3a5c6120bb0027207ba8214439929e":"333778176604527064","01d77dbc0e3a798edfba46ff234c3109184c28de48c600a09c17850098d1747c1c":"143654102359810937","01dbf36160e6cf1664bcf3a510e19f606c1d84dc5e53dd08d7e4a9ade9db126dff":"21695565658125148","01de0f987b1085ff99283fde29f7b18b0b52c97d94f5b2124630017ada60de0982":"999704901962","01e04018a67f239124ab5769db728b9bb586139af782e2b30bb06144b7914fbdd3":"2996175517185","01e2b343688101930b63af177df340815c1d8ce16dd9bc2f799902cb52d64bd5a5":"1000087279559","01f210a4e89a5a4e81f4ccd6cf7a9e7c9d6dc25b168afafa7da7a5ec4809ad2649":"27532576039627922","01f24c144f286126b1f85984843e393e1b95d05f6b6d7eed6a6148b6adc8668c3d":"27878166876858855","01f2a124115721f18b7c1ace2b2d8b6d4980e7a7263b53936a41288fbfe2f220cb":"1000058835737","01f35b161e8e73fe079e37c15b7edd58b6293c0ac41bd4cdf1ae27b970227dada2":"38757437142893239","01f39dacb5ca4ac415041d1df96f043abe911e385cf6da99532287ebfc7947cbe0":"1901012601442","01f8cc19ba142d7e82de13065634de13f011f3ca32141ec144cc6e4fdfd2697ce3":"27968764892495825","01f93b4d887963276b11859aef9959b4caff61bd0cee5859698f4f9be367320681":"27474966119977280","01f979b2820db754b82c25823f9886d3fc1e941e3442372dc9d40d0d2fd29156ce":"999934905482","01f9a00a3712a1ba5dcee00af368f07d384ccaebb3c840c34c5b322395419ba4d9":"166889088302262840","01fe61249c459693809bf4f789dd38bc3b7772aa4ffaf642cc6993f4a1004df6c1":"39919834499557561"}},"timestamp":"2021-03-19T07:08:02.944Z","era_id":42,"height":15429,"protocol_version":"1.0.1"},"body":{"proposer":"018db4ea42689acfc05449c87eeb7970bc6f4bacd6571f8361ffc17dd9d6ae7914","deploy_hashes":[],"transfer_hashes":[]}}}}');
        // storage.onEvent(sourceNode.id, apiVersion.id, '{"BlockAdded":{"block_hash":"25789c47782f502c1400d42a470556b603145bd6a1694ef551b0dd9072416910","block":{"hash":"25789c47782f502c1400d42a470556b603145bd6a1694ef551b0dd9072416910","header":{"parent_hash":"70728dcb46dc7a683269d496869ac628c7b0ee5f2b7490a4d1d22b23e1379c5e","state_root_hash":"be2f3ab87d9239234315d3f1bacae86af192451cb0e38046f08c83ac5a110190","body_hash":"33be5712fb3c1b1c997dd7736b60280cb17fc5d500725c0478d1109d1362a71c","random_bit":false,"accumulated_seed":"c57d7f557658c8b51c19d4a0c932f6d0b72c967f5ebcc5219bdc62c0b1d8488b","era_end":{"era_report":{"equivocators":[],"rewards":{"0102b0d1560c9909760a778b4b2ef5601461221c117e57c33ca8571888515ca65d":27457842,"010427c1d1227c9d2aafe8c06c6e6b276da8dcd8fd170ca848b8e3e8e1038a6dc8":52169079,"0105220d6629f6ef4484e2da5f58b6222832af8cabba4fbd7f1ad55e84a06ab319":1978733046,"0105e2c338d31db049db93012f9a158993c0f5e330bf6c71ac38c165b1047af511":28004564,"01068e4432b4ac5f6469fe08a92f84ebb7518b1a1a7f6b42651803067035fdca82":1097550652,"01074597a876bc3af182c41990cc5752a1ceba49ef82c455ff9051f932d96af6b4":40973188,"01075ec8809c691a1d1b0250ba9ea75da5460e3df43c3172771c6975c989457159":1138620590808,"010819b194079ef88b6ce54b85c3ca75318dead7984d9ff36f9fcdf84eb089d638":520858571,"010a0edc88c2f20b0934923f7078a9c4611e37d6317309b4fc302d8222f0a1075d":1905055944726,"010d69a3bc86aed2a94e043e5a3ec9c5c710aecbb6b07d8fb5ba16cd4cfbbaa2fa":39817739,"010fe1c87fe78e4bd89c767f1c8b9ba0a90ff5537e47e3ed006efccb8e67762830":27457018,"0112357f15cf6461a772978c6fc72d93bc10c1abda3a85ee7b7feb593c785b95be":27624082,"011538e2431680e2873a60c00b23839af9e45088adb240a12621479c951afc566c":28004564,"011a65da6d839ecf30e4ef24952ee84125f7a955291cd752324ea44a98b65c7614":27735514,"011bb356b5af429f397bc5b0fbc71bb2b2384d6253b7f3cda92db8758dbdc4c728":82234055,"0122f8d85b44cc2daee730c2afa97cdd6d0b46a9e132dd18292e39f8193b24d037":82402254,"0124bc9f7cc9f53a34c79d7ab94f2926c7ad368ca8bcd11b2142f01a005526d2c5":0,"0125c16a4a387062414d59eb2a1387d3b380a1d4fede2994c582d07510a004c027":3944119773132,"01260f18d5f4939822731f010aff192dffef3243abaab455c02872ba866b663b71":714795970708,"01267447c9ac87b4330ed3395db95efbba78394533666f29a56e8a1ec7b31abbd4":27434562,"012836dbe9919b1ee2b93636853ac4190e891f5f815fcc8181166e308d4050ddb3":28004564,"012a7750db3ad70a6adaecd353ddfc9c13f3694659d2e55d9460b6ca10648c02f3":27457940,"012dc55b77b2a9faf75dbaed15775ddfc48e60c4596608318c8b96b1900bdf1d5f":54450225,"012e26890209f5234fdc707c2086ef84314bba0e2cc9c7cdbe199859152b3fdc30":595663286024,"0135251e59c6f01800c51c4961ef37ebd34575e28c0942fdffd2ea34b09c54f86a":3573981459298,"0138e7246e373b4b925e1081741794c77a5866cdf90061965442134f0fe59c60a1":30867964,"013d357017db22c9135245601751e5da3be0de9fee01fd2ba919e07c6ee98c5837":27457016,"013f774a58f4d40bd9b6cce7e306e53646913860ef2a111d00f0fe7794010c4012":9164080332916,"0140e8b6d23614355e04e1e1fab97d54ea3cb6fa1e6db6c65ba6cb21ee7c6a81cc":1786989607465,"0142f890ea38eacce7d24473d837147a0312c0db7400e5671fadc5b985090e1ecc":914551352954,"0146c61d107ffb32738fdbb837213b240bf872536f326465642e467fe6884e7cdc":28325203,"01473e65039f446dab9c1953e0ef951c1d46a60d4de44b95643bc3c80c70134af3":27456913,"014b466f5c6c87bb1d2566d166120e320a724231374cd0775e0e347afed70a4745":53867549,"014c28b6968597cbadb50ed0468f9a4f0dbfcac6e06737345e04e4d2f99f0002dd":1009418900104,"014d5eb3ac23735e695ae372defa057ca089a921f08a199415cc73fd118f68dc94":595662877727,"014fdd08ed688b19cd92fb93be9b2a9108361f63edc7d0b1fda84f3e45e3bbd8e3":1044488615174,"0155737201251fe651ef332c6b21627498145490e8534f8b7a1d5f3a5d98ceaa67":27461960,"01587265e95c4d895c912d3091b76d7d6034f9b5b6c38074c8f88244f65813cb0c":2875382195232,"015c3b543739fe8fa56cb1b09a91c3ed8ec0febbe6977bd8cb5273956094b8d7bb":476530669317,"015da9ac1f6508be409bc6ed45bc44c6afd6d94b90d60014576418a79b61d563a2":2982150061890,"015e8eb1a4bcbe3b6d786ca160ba5ee8d49671a3f3bb496728879370eae1c1d4c1":0,"0161a3701643407ee0094844264e43c2f8443e07c6871c16e94116a56b3028d3a5":1945214561879,"0161c5fdc6db7ddaa7770478fcba908412bdd570fb8b5133c81b7db707400c9d47":82123742,"0167601f851607ac0279fd8e7a2af6abe280b7c9dc52dc21d27bc0eab431d14fd4":30239458,"0167706181a308089391dda197cad09b836f2a2870bbf62ad7080780a8ea952669":28004564,"01683b6e508120d7e970f86cdc29e7a317b5d18925cc368f4400c4e39e06ea879d":595663031202,"0169740c39d54535e8702b03e80f3dc799b63c258319abe4b42547195ad0cf1b7a":28004564,"016c32abc5867fb9d5fac0ff6b6cdb959101a505a2e8137ea8ca07e120a4775aa8":82209749,"016df1d80aafc6cca6dc54248132386a1188b665f6ce92b6f4e218fc408aa3dc4b":849429761,"016ffbc278c0268817468117f2b59141b666422b9b251b5c2c0bb8a17c26fe575b":27457634,"0173d441e42fc9ededfa47073ea0023b1c9488087efa5f631e35103d8a1efc1e7f":50686090,"0180187dda20ca4d0108ea54a31a6764bbd46c01420b1ab53e714f8761372a7ad3":145355847,"01840a8258ad22e9f1237f4d96a36fc2841635ba8d831fb73956f55426fbce54b1":858964250230,"01852d3355d56dcb1c62fae151aef4ab264739af6e32e247dc9b5237b096472983":26927995,"0188a8f71663f01d2cf394d7e0ce577bd11b34bb6d2aa55f09071fb3c64f94a51b":27458458,"0188d873a9e784e824ef3bd1581a4994fbb5eead58cb92e909542c7b9d65b15ae7":35155954,"0189427f604fbfa62aa7d204a6c3f0034a910be6a4a5839cbf53cc10361b5e4c28":659585959,"018977df4885899e3791ca6011ad46f3285d48a8b47900f92c5a7dd04af4c05d35":27446507,"018b15761be0c527117c79b87ca013b014a4628f01e382902a139529406723d86b":9164052869929,"018db4ea42689acfc05449c87eeb7970bc6f4bacd6571f8361ffc17dd9d6ae7914":1000827422303,"018dc552de3c403dbefe03a9c604e11346d96159ed49f9381a55c2e06c45197d43":374862433231,"019078cbad006cf86c6f3e8b226f8ad3d24d346952077152d6d9a5d13f02658554":27490390,"0190dd8430afb0958c25636596d1e98478ebe240c81260becf687cdf90ee088860":595663431563,"01921a3c9c9837c9e11cf34d2495abb522a7d5f74bc2218df45fefb91c96deb988":3944109630305,"0192fe0efbf65cafa7aca49094af2fe01b4ed8bc8abdbd8c078476e9650c4b99ae":758858481293,"0199bc243a7497f5b0f384636cf5fe6c6f7f33113061de613959564c574ec8d61b":27457737,"019d4fa301d6a288609dcd2fa85dc84dbed8ee9361cbbf40e4c85071da2a4332d2":833928789395,"01a4707d761e69f5838d77c2edcf378e9c51a82048fdafff389bba60aeff58210e":4579948675465,"01b1e495b07045f098d04d729947d8efb6a471c7b5ba69b461c980a276f56957c1":2978316055084,"01b242ed64fdafb8bdfc2f52ef8571ce12c348a664442cba4a1c079ea5d9a26c0a":4582026118031,"01b40a3ade2c223139c2928f2481e9782768ed2b3500bbc2efc191ef29c856284a":543788737,"01b4447a791cfea22f8293a165e7c7895121347a18845791c6bdea536437be99b4":82263925,"01b677d508c9b784c376c799033b20c1d1398694e2fe734f2e262a18600dc630fa":1047029664589,"01b7a5935f85710aa79e346bfe93f90d813bc20234dbd9211bcf8d2af8784520c2":476509471300,"01b9137fcbb85baf03db2aa41e459199b27514a9943a0d2776752974c793905880":991133094186,"01b9c53d13b3c6021f3dcc1f7dca5c22b01b5ac6a273b8054e9a8dd090e739a848":4114920851181,"01bb61d3077d403e9429200265fbbe1f3f0521b6d07efc2daff7f29e37393c5731":2101321454557,"01bb9d7599bb8a0464946f8b7d812db16c80fb66ae345a7649d8cba96215b4a591":1191330859003,"01c3e639b8a789b61ec3ec10d32aa928496fd2a8239b90116db0c10008a8bb468f":898404408492,"01c444f05da5781071c6375575d713193f4495bd6d83c4ef4e788502e2c8c09a9d":82207378,"01c485e408cb73557a008f28a5761a7368e0a0dccfe89ea6ffcd3883d41d3065be":740781559651,"01c91d7ac17e2289740a33d61c4dffeab43937f6c1fc0820ebcea2c199ccd73e16":27462063,"01cee72144d6729a450cc929b738311f0cf6a32e5ba872466d8dd57c6b8b0b9121":27441566,"01d2000024c05927e9958293bcb4de2e8f5e85b99f23e4260008e56dcd2088fd8e":1147475561990,"01d62fc9b894218bfbe8eebcc4a28a1fc4cb3a5c6120bb0027207ba8214439929e":9164052869929,"01d77dbc0e3a798edfba46ff234c3109184c28de48c600a09c17850098d1747c1c":3944097850818,"01dbf36160e6cf1664bcf3a510e19f606c1d84dc5e53dd08d7e4a9ade9db126dff":595663002151,"01de0f987b1085ff99283fde29f7b18b0b52c97d94f5b2124630017ada60de0982":27447334,"01e04018a67f239124ab5769db728b9bb586139af782e2b30bb06144b7914fbdd3":82261455,"01e2b343688101930b63af177df340815c1d8ce16dd9bc2f799902cb52d64bd5a5":27457840,"01f210a4e89a5a4e81f4ccd6cf7a9e7c9d6dc25b168afafa7da7a5ec4809ad2649":755921148078,"01f24c144f286126b1f85984843e393e1b95d05f6b6d7eed6a6148b6adc8668c3d":765409523601,"01f2a124115721f18b7c1ace2b2d8b6d4980e7a7263b53936a41288fbfe2f220cb":27457116,"01f35b161e8e73fe079e37c15b7edd58b6293c0ac41bd4cdf1ae27b970227dada2":1064105528640,"01f39dacb5ca4ac415041d1df96f043abe911e385cf6da99532287ebfc7947cbe0":52193284,"01f8cc19ba142d7e82de13065634de13f011f3ca32141ec144cc6e4fdfd2697ce3":767896939174,"01f93b4d887963276b11859aef9959b4caff61bd0cee5859698f4f9be367320681":754339437852,"01f979b2820db754b82c25823f9886d3fc1e941e3442372dc9d40d0d2fd29156ce":27453717,"01f9a00a3712a1ba5dcee00af368f07d384ccaebb3c840c34c5b322395419ba4d9":4582026434962,"01fe61249c459693809bf4f789dd38bc3b7772aa4ffaf642cc6993f4a1004df6c1":1096019750655},"inactive_validators":["0124bc9f7cc9f53a34c79d7ab94f2926c7ad368ca8bcd11b2142f01a005526d2c5","015e8eb1a4bcbe3b6d786ca160ba5ee8d49671a3f3bb496728879370eae1c1d4c1"]},"next_era_validator_weights":{"0102b0d1560c9909760a778b4b2ef5601461221c117e57c33ca8571888515ca65d":"1000122086772","010427c1d1227c9d2aafe8c06c6e6b276da8dcd8fd170ca848b8e3e8e1038a6dc8":"1900196094660","0105220d6629f6ef4484e2da5f58b6222832af8cabba4fbd7f1ad55e84a06ab319":"72072958816987","0105e2c338d31db049db93012f9a158993c0f5e330bf6c71ac38c165b1047af511":"1020000000000","01068e4432b4ac5f6469fe08a92f84ebb7518b1a1a7f6b42651803067035fdca82":"39976956293403","01074597a876bc3af182c41990cc5752a1ceba49ef82c455ff9051f932d96af6b4":"1492399287160","01075ec8809c691a1d1b0250ba9ea75da5460e3df43c3172771c6975c989457159":"41472876741511236","010819b194079ef88b6ce54b85c3ca75318dead7984d9ff36f9fcdf84eb089d638":"18971000000000","010a0edc88c2f20b0934923f7078a9c4611e37d6317309b4fc302d8222f0a1075d":"69389356749326227","010d69a3bc86aed2a94e043e5a3ec9c5c710aecbb6b07d8fb5ba16cd4cfbbaa2fa":"1450316324760","010fe1c87fe78e4bd89c767f1c8b9ba0a90ff5537e47e3ed006efccb8e67762830":"1000091885482","0112357f15cf6461a772978c6fc72d93bc10c1abda3a85ee7b7feb593c785b95be":"1006175920233","011538e2431680e2873a60c00b23839af9e45088adb240a12621479c951afc566c":"1020000000000","011a65da6d839ecf30e4ef24952ee84125f7a955291cd752324ea44a98b65c7614":"1020000000000","011bb356b5af429f397bc5b0fbc71bb2b2384d6253b7f3cda92db8758dbdc4c728":"2995276094811","0122f8d85b44cc2daee730c2afa97cdd6d0b46a9e132dd18292e39f8193b24d037":"3001403774736","0125c16a4a387062414d59eb2a1387d3b380a1d4fede2994c582d07510a004c027":"143659788444680059","01260f18d5f4939822731f010aff192dffef3243abaab455c02872ba866b663b71":"26035577987372872","01267447c9ac87b4330ed3395db95efbba78394533666f29a56e8a1ec7b31abbd4":"999273367454","012836dbe9919b1ee2b93636853ac4190e891f5f815fcc8181166e308d4050ddb3":"1020000000000","012a7750db3ad70a6adaecd353ddfc9c13f3694659d2e55d9460b6ca10648c02f3":"1000122320114","012dc55b77b2a9faf75dbaed15775ddfc48e60c4596608318c8b96b1900bdf1d5f":"1983286244601","012e26890209f5234fdc707c2086ef84314bba0e2cc9c7cdbe199859152b3fdc30":"21696314155848942","0135251e59c6f01800c51c4961ef37ebd34575e28c0942fdffd2ea34b09c54f86a":"130177948408659552","0138e7246e373b4b925e1081741794c77a5866cdf90061965442134f0fe59c60a1":"1124330471995","013d357017db22c9135245601751e5da3be0de9fee01fd2ba919e07c6ee98c5837":"1000091242327","013f774a58f4d40bd9b6cce7e306e53646913860ef2a111d00f0fe7794010c4012":"333790533154190352","0140e8b6d23614355e04e1e1fab97d54ea3cb6fa1e6db6c65ba6cb21ee7c6a81cc":"65088933331815919","0142f890ea38eacce7d24473d837147a0312c0db7400e5671fadc5b985090e1ecc":"33311425984247898","0146c61d107ffb32738fdbb837213b240bf872536f326465642e467fe6884e7cdc":"1031712949554","01473e65039f446dab9c1953e0ef951c1d46a60d4de44b95643bc3c80c70134af3":"1000087753313","014b466f5c6c87bb1d2566d166120e320a724231374cd0775e0e347afed70a4745":"1962062020477","014c28b6968597cbadb50ed0468f9a4f0dbfcac6e06737345e04e4d2f99f0002dd":"36766861553478801","014d5eb3ac23735e695ae372defa057ca089a921f08a199415cc73fd118f68dc94":"21696299282241904","014fdd08ed688b19cd92fb93be9b2a9108361f63edc7d0b1fda84f3e45e3bbd8e3":"38044233473254779","0155737201251fe651ef332c6b21627498145490e8534f8b7a1d5f3a5d98ceaa67":"1000270926711","01587265e95c4d895c912d3091b76d7d6034f9b5b6c38074c8f88244f65813cb0c":"104732315858881863","015c3b543739fe8fa56cb1b09a91c3ed8ec0febbe6977bd8cb5273956094b8d7bb":"17357052798747928","015da9ac1f6508be409bc6ed45bc44c6afd6d94b90d60014576418a79b61d563a2":"108621206161942128","015e8eb1a4bcbe3b6d786ca160ba5ee8d49671a3f3bb496728879370eae1c1d4c1":"1020000000000","0161a3701643407ee0094844264e43c2f8443e07c6871c16e94116a56b3028d3a5":"70852085765782354","0161c5fdc6db7ddaa7770478fcba908412bdd570fb8b5133c81b7db707400c9d47":"2991259087884","0167601f851607ac0279fd8e7a2af6abe280b7c9dc52dc21d27bc0eab431d14fd4":"1101438567510","0167706181a308089391dda197cad09b836f2a2870bbf62ad7080780a8ea952669":"1020000000000","01683b6e508120d7e970f86cdc29e7a317b5d18925cc368f4400c4e39e06ea879d":"21696304874152418","0169740c39d54535e8702b03e80f3dc799b63c258319abe4b42547195ad0cf1b7a":"1020000000000","016c32abc5867fb9d5fac0ff6b6cdb959101a505a2e8137ea8ca07e120a4775aa8":"2994392915600","016df1d80aafc6cca6dc54248132386a1188b665f6ce92b6f4e218fc408aa3dc4b":"30939451326524","016ffbc278c0268817468117f2b59141b666422b9b251b5c2c0bb8a17c26fe575b":"1000112966161","0173d441e42fc9ededfa47073ea0023b1c9488087efa5f631e35103d8a1efc1e7f":"1846182104813","0180187dda20ca4d0108ea54a31a6764bbd46c01420b1ab53e714f8761372a7ad3":"5294414429523","01840a8258ad22e9f1237f4d96a36fc2841635ba8d831fb73956f55426fbce54b1":"31286733055379371","01852d3355d56dcb1c62fae151aef4ab264739af6e32e247dc9b5237b096472983":"999951426556","0188a8f71663f01d2cf394d7e0ce577bd11b34bb6d2aa55f09071fb3c64f94a51b":"1000143919002","0188d873a9e784e824ef3bd1581a4994fbb5eead58cb92e909542c7b9d65b15ae7":"1280515173174","0189427f604fbfa62aa7d204a6c3f0034a910be6a4a5839cbf53cc10361b5e4c28":"24024623705490","018977df4885899e3791ca6011ad46f3285d48a8b47900f92c5a7dd04af4c05d35":"999706910591","018b15761be0c527117c79b87ca013b014a4628f01e382902a139529406723d86b":"333789532847706891","018db4ea42689acfc05449c87eeb7970bc6f4bacd6571f8361ffc17dd9d6ae7914":"36453927374917361","018dc552de3c403dbefe03a9c604e11346d96159ed49f9381a55c2e06c45197d43":"17369094718587709","019078cbad006cf86c6f3e8b226f8ad3d24d346952077152d6d9a5d13f02658554":"1001307547397","0190dd8430afb0958c25636596d1e98478ebe240c81260becf687cdf90ee088860":"21696319456614441","01921a3c9c9837c9e11cf34d2495abb522a7d5f74bc2218df45fefb91c96deb988":"143659419002182992","0192fe0efbf65cafa7aca49094af2fe01b4ed8bc8abdbd8c078476e9650c4b99ae":"27640501597769254","0199bc243a7497f5b0f384636cf5fe6c6f7f33113061de613959564c574ec8d61b":"1000116712385","019a85d7370f913f0a9f55a12da2b031d8c0a36752cd8fd7ff0b47cff0d4fc57bd":"999066979491","019d4fa301d6a288609dcd2fa85dc84dbed8ee9361cbbf40e4c85071da2a4332d2":"30374846698746907","01a4707d761e69f5838d77c2edcf378e9c51a82048fdafff389bba60aeff58210e":"166819086549971896","01b1e495b07045f098d04d729947d8efb6a471c7b5ba69b461c980a276f56957c1":"108481557105287146","01b242ed64fdafb8bdfc2f52ef8571ce12c348a664442cba4a1c079ea5d9a26c0a":"166894754881132133","01b40a3ade2c223139c2928f2481e9782768ed2b3500bbc2efc191ef29c856284a":"19806847114203","01b4447a791cfea22f8293a165e7c7895121347a18845791c6bdea536437be99b4":"2996365410098","01b677d508c9b784c376c799033b20c1d1398694e2fe734f2e262a18600dc630fa":"38136788120823992","01b7a5935f85710aa79e346bfe93f90d813bc20234dbd9211bcf8d2af8784520c2":"17356280685831056","01b9137fcbb85baf03db2aa41e459199b27514a9943a0d2776752974c793905880":"36100823207382562","01b9c53d13b3c6021f3dcc1f7dca5c22b01b5ac6a273b8054e9a8dd090e739a848":"149881010960508757","01bb61d3077d403e9429200265fbbe1f3f0521b6d07efc2daff7f29e37393c5731":"76538090368459884","01bb9d7599bb8a0464946f8b7d812db16c80fb66ae345a7649d8cba96215b4a591":"43392784453730466","01c3e639b8a789b61ec3ec10d32aa928496fd2a8239b90116db0c10008a8bb468f":"32723293076491112","01c444f05da5781071c6375575d713193f4495bd6d83c4ef4e788502e2c8c09a9d":"2994305031819","01c485e408cb73557a008f28a5761a7368e0a0dccfe89ea6ffcd3883d41d3065be":"26982071606237096","01c91d7ac17e2289740a33d61c4dffeab43937f6c1fc0820ebcea2c199ccd73e16":"1000275387444","01cee72144d6729a450cc929b738311f0cf6a32e5ba872466d8dd57c6b8b0b9121":"999528087078","01d2000024c05927e9958293bcb4de2e8f5e85b99f23e4260008e56dcd2088fd8e":"43712852314585821","01d62fc9b894218bfbe8eebcc4a28a1fc4cb3a5c6120bb0027207ba8214439929e":"333789532847706891","01d77dbc0e3a798edfba46ff234c3109184c28de48c600a09c17850098d1747c1c":"143658989949936655","01dbf36160e6cf1664bcf3a510e19f606c1d84dc5e53dd08d7e4a9ade9db126dff":"21696303813393476","01de0f987b1085ff99283fde29f7b18b0b52c97d94f5b2124630017ada60de0982":"999738900451","01e04018a67f239124ab5769db728b9bb586139af782e2b30bb06144b7914fbdd3":"2996277456999","01e2b343688101930b63af177df340815c1d8ce16dd9bc2f799902cb52d64bd5a5":"1000121305836","01f210a4e89a5a4e81f4ccd6cf7a9e7c9d6dc25b168afafa7da7a5ec4809ad2649":"27533512789394027","01f24c144f286126b1f85984843e393e1b95d05f6b6d7eed6a6148b6adc8668c3d":"27879115384774106","01f2a124115721f18b7c1ace2b2d8b6d4980e7a7263b53936a41288fbfe2f220cb":"1000092860997","01f35b161e8e73fe079e37c15b7edd58b6293c0ac41bd4cdf1ae27b970227dada2":"38758755799750002","01f39dacb5ca4ac415041d1df96f043abe911e385cf6da99532287ebfc7947cbe0":"1901077280128","01f8cc19ba142d7e82de13065634de13f011f3ca32141ec144cc6e4fdfd2697ce3":"27969716482856743","01f93b4d887963276b11859aef9959b4caff61bd0cee5859698f4f9be367320681":"27475900909662339","01f979b2820db754b82c25823f9886d3fc1e941e3442372dc9d40d0d2fd29156ce":"999968926519","01f9a00a3712a1ba5dcee00af368f07d384ccaebb3c840c34c5b322395419ba4d9":"166894766423852752","01fe61249c459693809bf4f789dd38bc3b7772aa4ffaf642cc6993f4a1004df6c1":"39921192705036643"}},"timestamp":"2021-03-19T09:08:11.904Z","era_id":43,"height":15533,"protocol_version":"1.0.1"},"body":{"proposer":"01f9a00a3712a1ba5dcee00af368f07d384ccaebb3c840c34c5b322395419ba4d9","deploy_hashes":[],"transfer_hashes":[]}}}}');
        // throw new Error('The end');
        stream.on('line', async (eventString) => {
            // console.log(eventString);

            try {
                if (eventString.startsWith('id')) {
                    await storage.onEventId(sourceNode.id, apiVersion.id, eventString.substr(3));
                }
                else if (eventString.startsWith('data')) {
                    await storage.onEvent(sourceNode.id, apiVersion.id, eventString.substr(5));
                }
            } catch (err) {
                console.log(`Error: Error while processing an event.\nEvent: ${eventString}\nError: ${err}`);
            }
        });
    } catch (err) {
        console.error(err);
        if (err instanceof got.stream.RequestError) {
            throw new Error("Connection Failed - check the status of the node:\n" + err);
        } else {
            throw new Error(err);
        }
    }
}

// For debugging
if (env !== 'test') {
    runEventHandler();
}

module.exports = runEventHandler;
